---
import Layout from '../layouts/Layout.astro';
---

<Layout title="–°–∫–ª–∞–¥ | Admin Panel">
    <div class="min-h-screen bg-white text-black p-4 pb-20">
        <div class="sticky top-0 bg-white/95 backdrop-blur-sm z-10 pb-4 border-b border-gray-100">
            <h1 class="text-2xl font-bold mb-4 font-sans text-black">–°–∫–ª–∞–¥</h1>
            <div class="relative">
                <input 
                    type="text" 
                    id="search-input"
                    placeholder="–ü–æ–∏—Å–∫ –∞—Ä–æ–º–∞—Ç–∞..." 
                    class="w-full bg-gray-100 border-none rounded-xl px-4 py-3 text-lg focus:ring-2 focus:ring-black outline-none transition-all"
                >
                <div class="absolute right-3 top-3 text-gray-400">
                    üîç
                </div>
            </div>
        </div>

        <div id="product-list" class="space-y-3 mt-4">
            <!-- Items injected via JS -->
            <div class="animate-pulse space-y-3">
                <div class="h-20 bg-gray-100 rounded-xl"></div>
                <div class="h-20 bg-gray-100 rounded-xl"></div>
                <div class="h-20 bg-gray-100 rounded-xl"></div>
            </div>
        </div>
    </div>

    <!-- Telegram WebApp Script -->
    <script src="https://telegram.org/js/telegram-web-app.js" is:inline></script>
</Layout>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram?.WebApp;
    if (tg) {
        tg.expand();
        tg.enableClosingConfirmation();
    }

    const API_URL = '/api/products'; // Relative path for Docker/Nginx

    let allProducts = [];

    // –ó–∞–≥—Ä—É–∑–∫–∞
    async function loadData() {
        try {
            const res = await fetch(API_URL);
            allProducts = await res.json();
            renderList(allProducts);
        } catch (e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
        }
    }

    // –†–µ–Ω–¥–µ—Ä
    function renderList(products) {
        const list = document.getElementById('product-list');
        if (!list) return;

        list.innerHTML = products.map(p => `
            <div class="flex items-center justify-between bg-white border border-gray-100 shadow-sm rounded-xl p-3 animate-fade-in">
                <div class="flex items-center gap-3 flex-1 min-w-0">
                    <img src="${p.image}" class="w-12 h-12 rounded-lg object-cover bg-gray-50" onerror="this.src='https://via.placeholder.com/50'">
                    <div class="truncate">
                        <p class="font-bold text-sm truncate">${p.name}</p>
                        <p class="text-xs text-gray-500 truncate">${p.brand}</p>
                        <p id="stock-container-${p.id}" class="text-xs font-mono mt-1 ${p.stock <= 3 ? 'text-red-500' : 'text-green-600'}">
                            –û—Å—Ç–∞—Ç–æ–∫: <span id="stock-${p.id}" class="text-base font-bold">${p.stock}</span>
                        </p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 ml-2">
                    <button 
                        class="w-10 h-10 rounded-full bg-gray-100 hover:bg-red-50 hover:text-red-500 text-xl font-bold transition-colors flex items-center justify-center active:scale-95 touch-manipulation"
                        onclick="updateStock(${p.id}, -1)"
                    >‚àí</button>
                    <button 
                        class="w-10 h-10 rounded-full bg-gray-100 hover:bg-green-50 hover:text-green-500 text-xl font-bold transition-colors flex items-center justify-center active:scale-95 touch-manipulation"
                        onclick="updateStock(${p.id}, 1)"
                    >+</button>
                </div>
            </div>
        `).join('');
    }

    // –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.brand.toLowerCase().includes(term)
            );
            renderList(filtered);
        });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤
    window.updateStock = async (id, change) => {
        // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        const stockEl = document.getElementById(`stock-${id}`);
        const containerEl = document.getElementById(`stock-container-${id}`);
        
        if (stockEl) {
            const current = parseInt(stockEl.innerText);
            const newVal = Math.max(0, current + change);
            stockEl.innerText = newVal;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
            if (containerEl) {
                if (newVal <= 3) {
                    containerEl.classList.remove('text-green-600');
                    containerEl.classList.add('text-red-500');
                } else {
                    containerEl.classList.remove('text-red-500');
                    containerEl.classList.add('text-green-600');
                }
            }
            
            // –í–∏–±—Ä–∞—Ü–∏—è (Haptic Feedback)
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred(change > 0 ? 'light' : 'medium');
            }
        }

        try {
            const res = await fetch('/api/stock/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ product_id: id, change: change })
            });
            const data = await res.json();
            
            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∏–ª–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω - –æ–±–Ω–æ–≤–ª—è–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–µ—à–µ
                const prod = allProducts.find(p => p.id === id);
                if (prod) prod.stock = data.product.stock;
            } else {
                loadData(); // –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            }
        } catch (e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
            loadData(); // –û—Ç–∫–∞—Ç
        }
    };

    loadData();
</script>

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    /* –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø—Ä–∏ —Ç–∞–ø–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    button {
        -webkit-tap-highlight-color: transparent;
    }
</style>
